<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>BET300 ¬∑ Slot Express Navidad</title>
<meta name="theme-color" content="#070a16"/>
<style>
:root{
  --bg:#070a16;
  --panel:#0f132b;
  --panel2:#0b1026;
  --border:#1a2250;

  --text:#f2f5ff;
  --muted:#b5bddf;

  --gold:#facc15;
  --gold2:#f59e0b;

  --red:#ef4444;
  --green:#22c55e;
  --ice:#22d3ee;

  --neon:#37f3ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto;
  overflow-x:hidden;
}
body::before{
  content:"";
  position:fixed; inset:0; z-index:-2;
  background:
    radial-gradient(900px 500px at 70% -10%, rgba(250,204,21,.18), transparent),
    radial-gradient(700px 350px at 0% 0%, rgba(34,211,238,.16), transparent),
    radial-gradient(700px 420px at 100% 100%, rgba(239,68,68,.10), transparent),
    linear-gradient(180deg,#070a16 0%,#070a16 60%,#050812 100%);
}

/* Nieve */
.snow{position:fixed;inset:0;pointer-events:none;z-index:-1}
.snow i{
  position:absolute;top:-10px;
  width:6px;height:6px;border-radius:50%;
  background:rgba(255,255,255,.9);
  opacity:.8;
  filter:blur(.4px);
  animation:fall linear infinite;
}
@keyframes fall{
  0%{transform:translate3d(0,-10px,0)}
  100%{transform:translate3d(var(--drift,20px),110vh,0);opacity:0}
}

.container{max-width:980px;margin:6px auto 86px;padding:0 10px}
.card{
  background:
    radial-gradient(120% 100% at 50% 0%, rgba(250,204,21,.08), transparent),
    radial-gradient(120% 100% at 0% 0%, rgba(34,211,238,.08), transparent),
    var(--panel2);
  border:1px solid var(--border);
  border-radius:18px;
  padding:10px;
  box-shadow:0 15px 40px rgba(0,0,0,.35)
}
@media(min-width:900px){.grid{display:grid;grid-template-columns:1.05fr .95fr;gap:10px}}
@media(max-width:520px){.card{border-radius:0;border-left:0;border-right:0}}

/* Header */
.head{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px}
.pill{
  background:linear-gradient(90deg,rgba(239,68,68,.12),rgba(250,204,21,.12),rgba(34,211,238,.10));
  border:1px solid var(--border); border-radius:999px;
  padding:6px 8px; font-size:12px; color:var(--muted)
}
.pill.time{display:flex;gap:6px;align-items:center}
.pill.sound{cursor:pointer;user-select:none}
.pill:hover{filter:brightness(1.08)}
.count{
  display:inline-flex;gap:6px;align-items:center;padding:3px 8px;border-radius:999px;
  background:rgba(250,204,21,.14);
  border:1px solid rgba(250,204,21,.32);
  color:#ffe8a0;
  font-weight:800;
  font-variant-numeric:tabular-nums
}
.rightTop{margin-left:auto;display:flex;gap:8px;align-items:center}
.btnLink{
  display:inline-flex;gap:8px;align-items:center;
  padding:8px 10px;border-radius:12px;font-weight:900;
  background:linear-gradient(90deg,#ef4444,#facc15);
  color:#1a1202;text-decoration:none;
  border:1px solid rgba(255,255,255,.06);
  transition:transform .08s ease, box-shadow .08s ease;
}
.btnLink:hover{transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.35)}
.btnLink:focus-visible{outline:2px solid #facc15; outline-offset:2px; border-radius:14px}

.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px}
.center{text-align:center}
h1,h2,h3,p{margin:0 0 6px}
h1{font-size:20px}
.muted{color:var(--muted)}

/* Logo */
.logoWrap{display:grid;place-items:center;margin:6px 0 8px}
.logoBadge{
  display:flex;flex-direction:column;align-items:center;gap:6px;
  padding:10px 12px;border-radius:16px;
  background:linear-gradient(180deg,rgba(239,68,68,.14),rgba(250,204,21,.10),rgba(34,211,238,.08));
  border:1px solid var(--border);
  box-shadow:0 8px 22px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04);
  width:min(520px,100%);
}
.logoBadge img{
  height:56px;width:auto;display:block;
  filter:drop-shadow(0 3px 10px rgba(0,0,0,.55));
}
.logoBadge .sub{
  font-weight:900;
  letter-spacing:.18em;
  color:#ffe9a8;
  font-size:12px;
  text-transform:uppercase;
  opacity:.95;
}
@media(max-width:480px){
  .logoBadge img{height:48px}
  .logoBadge .sub{font-size:11px}
}

/* Stats */
.stat{display:flex;gap:10px;align-items:center;justify-content:center;margin:6px 0 8px}
.badge{
  min-width:66px;height:40px;border-radius:10px;
  background:radial-gradient(100% 100% at 50% 0%, rgba(34,211,238,.35), rgba(250,204,21,.22));
  display:grid;place-items:center;
  font-weight:900;font-size:16px;
  box-shadow:inset 0 0 10px rgba(34,211,238,.18)
}
.smallline{font-size:12px;color:var(--muted)}

/* Slot */
.stage{display:flex;justify-content:center}
.slotWrap{width:100%;max-width:520px;margin:4px auto 0;position:relative}
.slot{
  position:relative;border-radius:16px;padding:10px;
  background:linear-gradient(180deg,rgba(239,68,68,.14),rgba(250,204,21,.12),rgba(34,211,238,.10));
  border:1px solid var(--border);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.03), 0 10px 30px rgba(0,0,0,.35)
}
.reelFrame{
  position:relative;border-radius:14px;padding:8px;
  background:rgba(10,15,35,.65);
  border:1px solid #2a2f58
}
.reels{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
.reel{background:#0c1230;border-radius:10px;padding:6px;border:1px solid #30376a}
canvas.reelCanvas{
  width:100%;height:150px;display:block;border-radius:10px;
  background:linear-gradient(180deg,#0d1438,#0a102c)
}
@media(min-width:420px){canvas.reelCanvas{height:160px}}
@media(min-width:540px){canvas.reelCanvas{height:180px}}
.shadowTop,.shadowBot{position:absolute;left:0;right:0;height:24px;pointer-events:none}
.shadowTop{top:0;background:linear-gradient(180deg,rgba(10,15,35,.75),transparent)}
.shadowBot{bottom:0;background:linear-gradient(0deg,rgba(10,15,35,.75),transparent)}
.hint{text-align:center;color:var(--muted);font-size:12px;margin-top:4px}

/* Luces */
.bulbs{position:absolute;inset:-6px;pointer-events:none}
.bulbs i{position:absolute;width:8px;height:8px;border-radius:50%;box-shadow:0 0 10px rgba(255,255,255,.6)}
@keyframes bulbOn{0%{opacity:.35;transform:scale(.9)}50%{opacity:1;transform:scale(1)}100%{opacity:.35;transform:scale(.9)}}

/* FX */
.fx{position:absolute;inset:8px;pointer-events:none}
.fx canvas{position:absolute;inset:0;display:block}

/* Dock */
.dock{
  position:fixed;left:0;right:0;bottom:0;z-index:20;
  background:linear-gradient(180deg, rgba(11,15,30,0) 0%, rgba(11,15,30,.85) 22%, rgba(11,15,30,.95) 100%);
  padding:8px 10px 10px;display:flex;gap:8px
}
.btn{
  appearance:none;border:none;cursor:pointer;padding:12px 14px;border-radius:14px;font-weight:900;
  width:100%;
  box-shadow:0 8px 20px rgba(0,0,0,.35);
  transition:transform .06s ease, box-shadow .06s ease;
}
.btn:hover{transform:translateY(-1px); box-shadow:0 10px 22px rgba(0,0,0,.35)}
.btn:active{transform:translateY(0)}
.btn:disabled{opacity:.6;cursor:not-allowed}
#spinBtn{background:linear-gradient(90deg,var(--gold),var(--gold2));color:#1b1202}
.btn.ok{background:linear-gradient(90deg,var(--neon),#7cfaff);color:#03111a}

/* Confetti */
.confetti{position:fixed;inset:0;pointer-events:none;z-index:40}
.confetti i{position:absolute;top:-20px;width:10px;height:14px;border-radius:2px;opacity:0;animation:confFall 1.6s linear forwards}
@keyframes confFall{8%{opacity:1}100%{transform:translateY(110vh) rotate(360deg);opacity:0}}

/* Modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(4,6,14,.6);backdrop-filter:blur(4px);z-index:60}
.modal.show{display:flex}
.modalCard{width:min(520px,92vw);background:var(--panel2);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,.45)}
.modalHead{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.modalHead h3{margin:0;font-size:18px}
.modalBody{display:grid;gap:8px}
.row{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px dashed var(--border);border-radius:12px;padding:10px}
.k{color:var(--muted);font-size:13px}
.v{font-weight:900}
.actions{display:flex;gap:8px;margin-top:8px}
.btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
.closeX{margin-left:auto;cursor:pointer;opacity:.8}
.closeX:hover{opacity:1}

/* Historial */
.history{margin-top:8px}
.history h3{font-size:14px;color:var(--muted);margin-bottom:4px}
.history ul{list-style:none;padding:0;margin:0;display:grid;gap:4px}
.history li{font-size:12px;color:var(--muted);border:1px dashed var(--border);border-radius:10px;padding:6px 8px}

@media(max-width:420px){
  h1{font-size:18px}
  .panel{padding:8px}
  .stat{gap:8px}
  .badge{min-width:60px;height:36px;font-size:15px}
  .btn{padding:11px 12px}
}
</style>
</head>
<body>

<div class="snow" id="snow"></div>
<div id="confetti" class="confetti" aria-hidden="true"></div>

<!-- MODAL -->
<div id="prizeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modalCard">
    <div class="modalHead">
      <h3 id="modalTitle">üéÑ Premio obtenido</h3>
      <span id="closeModal" class="closeX" aria-label="Cerrar">‚úñ</span>
    </div>
    <div class="modalBody">
      <div class="row"><span class="k">Premio</span><span class="v" id="mPrize">‚Äî</span></div>
      <div class="row"><span class="k">C√≥digo</span><span class="v" id="mCode">‚Äî</span></div>
      <div class="row"><span class="k">Fecha/Hora</span><span class="v" id="mTs">‚Äî</span></div>
      <div class="actions">
        <button id="mClaim" class="btn ok">üì≤ Reclamar por WhatsApp</button>
        <button id="mClose" class="btn ghost">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="head">
      <span class="pill">üéÑ Slot Express Navidad</span>
      <span class="pill time">‚è≥ Tiempo limitado <span class="count" id="countdown">--:--</span></span>
      <span class="pill sound" id="soundToggle">üîä Sonido: <b id="soundState">ON</b></span>
      <div class="rightTop">
        <a id="playNow" class="btnLink" target="_blank" rel="noopener">üéÆ Entrar a la plataforma</a>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="logoWrap">
          <div class="logoBadge" aria-label="Bet300 Navidad">
            <img src="logo-navidad.svg" alt="BET300 Navidad" onerror="this.style.display='none'">
            <div class="sub">ESPECIAL NAVIDAD</div>
          </div>
        </div>

        <h1 class="center">üé∞ Slot Express</h1>

        <div class="stage">
          <div class="slotWrap slot" id="slotBox">
            <div class="bulbs" id="bulbs"></div>
            <div class="shadowTop"></div>
            <div class="reelFrame" id="reelFrame">
              <div class="fx"><canvas id="fx"></canvas></div>
              <div class="reels">
                <div class="reel"><canvas id="r1" class="reelCanvas" width="240" height="540"></canvas></div>
                <div class="reel"><canvas id="r2" class="reelCanvas" width="240" height="540"></canvas></div>
                <div class="reel"><canvas id="r3" class="reelCanvas" width="240" height="540"></canvas></div>
              </div>
            </div>
            <div class="shadowBot"></div>
            <div class="hint" id="hint">Tip: mejor visual en vertical üì±</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="center">
          <div class="stat">
            <div>
              <div class="badge" id="badge">-</div>
              <div class="smallline" id="stampLine" aria-live="polite"></div>
            </div>
            <div>
              <h2 id="title">Ten√©s 1 giro disponible</h2>
              <p class="muted" id="subtitle">Los premios se acreditan con tu <b>pr√≥xima carga m√≠nima</b>.</p>
            </div>
          </div>
        </div>

        <div class="panel" style="margin-top:6px">
          <p style="margin-bottom:6px"><b>Resultado actual</b></p>
          <p id="resultLine" class="muted">‚Äî</p>
        </div>

        <div class="panel history">
          <h3>üïì √öltimos giros</h3>
          <ul id="historyList"></ul>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="dock">
  <button id="spinBtn" class="btn">üéØ Girar</button>
  <button id="claimBtn" class="btn ok" disabled>üì≤ Reclamar</button>
</div>

<script>
/* ========= NIEVE ========= */
function setupSnow(){
  const snow = document.getElementById("snow");
  snow.innerHTML = "";
  const flakes = 42;
  for(let i=0;i<flakes;i++){
    const f = document.createElement("i");
    const size = 3 + Math.random()*4;
    f.style.width = f.style.height = size + "px";
    f.style.left = Math.random()*100 + "vw";
    f.style.opacity = (0.45 + Math.random()*0.55).toFixed(2);
    f.style.animationDuration = (7 + Math.random()*6) + "s";
    f.style.animationDelay = (Math.random()*-10) + "s";
    f.style.setProperty("--drift", (Math.random()*50-25) + "px");
    snow.appendChild(f);
  }
}
setupSnow();

/* ===== 5 PCs: ?pc=1|2|3|4|5 ===== */
const PLATFORM_LINKS = {
  pc1: "https://300vip-c01.vercel.app/",
  pc2: "https://300vip-c02.vercel.app/",
  pc3: "https://300vip-c03.vercel.app/",
  pc4: "https://alvge.bet300vip.com/",
  pc5: "https://www.bet300.biz/"
};

const WP_NUMBERS = {
  pc1: "54911171559478",
  pc2: "54911151622581",
  pc3: "54911154040255",
  pc4: "5491150030414",
  pc5: "5491150030414"
};

function normalizeWP(n){
  const s = String(n).replace(/[^\d+]/g, "");
  return s.startsWith("+") ? s.slice(1) : s;
}

const params = new URLSearchParams(location.search);
const pcParam = (params.get('pc')||"1").trim();
const pcMatch = /^[1-5]$/.test(pcParam) ? pcParam : "1";
const pcKey   = "pc"+pcMatch;

document.getElementById('playNow').href = PLATFORM_LINKS[pcKey];
const WP = normalizeWP(WP_NUMBERS[pcKey]);
const pc = pcMatch;

/* ===== Antifraude ===== */
const SALT = "bet300-slot-navidad-v1";
function ensureDeviceId(){
  let id = localStorage.getItem('device_id');
  if(!id){
    id = (crypto.randomUUID?.() || `${Date.now()}-${Math.random().toString(36).slice(2,8)}`);
    localStorage.setItem('device_id', id);
  }
  return id;
}
const DEVICE_ID = ensureDeviceId();
function todayKey(){
  const n=new Date();
  return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;
}
function tsString(d=new Date()){
  const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,'0'),mi=String(d.getMinutes()).padStart(2,'0');
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}
async function sha256hex(msg){
  const enc = new TextEncoder().encode(msg);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function makeClaimCode(prizeLabel){
  const base = `${DEVICE_ID}|${todayKey()}|${prizeLabel}|pc:${pc}|${SALT}`;
  const hex = await sha256hex(base);
  return hex.slice(0,10).toUpperCase();
}

/* ===== Sonido ===== */
let soundOn = true;
const soundToggle = document.getElementById('soundToggle');
const soundState  = document.getElementById('soundState');
const AudioKit = (()=> {
  const Ctx = window.AudioContext || window.webkitAudioContext;
  const ctx = new Ctx(); let unlocked=false;
  function unlock(){ if(!unlocked){ ctx.resume().catch(()=>{}); unlocked=true; } }
  function blip(freq=900,dur=0.035,vol=0.06,type='square'){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=0;
    o.connect(g).connect(ctx.destination);
    const t=ctx.currentTime;
    g.gain.linearRampToValueAtTime(vol, t+0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
    o.start(t); o.stop(t+dur);
  }
  function spinLoop(){ const id=setInterval(()=>blip(820+Math.random()*220,0.028,0.05,'square'),80); return ()=>clearInterval(id); }
  function win(kind){
    if(kind==='jackpot'){ [660,880,1100,1320,1560].forEach((f,i)=>setTimeout(()=>blip(f,0.12,0.09,'sawtooth'), i*110)); return; }
    if(kind==='triple'){ [660,880,1100].forEach((f,i)=>setTimeout(()=>blip(f,0.12,0.09,'triangle'), i*120)); return; }
    if(kind==='pair'){ [660,880].forEach((f,i)=>setTimeout(()=>blip(f,0.10,0.08,'square'), i*120)); return; }
    blip(420,0.07,0.05,'sine');
  }
  return {unlock,spinLoop,win};
})();
soundToggle.addEventListener('click',()=>{ soundOn=!soundOn; soundState.textContent=soundOn?'ON':'OFF';});

/* ===== Slot navide√±o ===== */
const SYMBOLS = ["üéÅ","üéÑ","‚≠ê","üîî","üç¨","üß¶","‚ùÑÔ∏è","ü¶å","BET300"];
const COLS = [document.getElementById('r1'),document.getElementById('r2'),document.getElementById('r3')];
const CTX = COLS.map(c=>c.getContext('2d'));
let reelY = [0,0,0], spinning=false;

let haloActive=false, haloUntil=0;
const fxCanvas = document.getElementById('fx');
const reelFrameEl = document.getElementById('reelFrame');
let fxCtx, fxW=0, fxH=0, winFX=null;
let winAnim = { cells:{0:new Set(),1:new Set(),2:new Set()}, until:0 };

function sizeFx(){
  const dpr = window.devicePixelRatio||1;
  const rect = reelFrameEl.getBoundingClientRect();
  fxW = Math.floor(rect.width*dpr);
  fxH = Math.floor(rect.height*dpr);
  fxCanvas.width = fxW; fxCanvas.height = fxH;
  fxCanvas.style.width = rect.width+'px';
  fxCanvas.style.height = rect.height+'px';
  fxCtx = fxCanvas.getContext('2d');
}
window.addEventListener('resize', ()=>{ clearTimeout(window.__fxTo); window.__fxTo=setTimeout(()=>{ sizeFx(); placeBulbs(); }, 120); });

function flashWin(lines){ winFX = { lines, until: Date.now()+1100 }; }
function renderWinFX(){
  if(!fxCtx) return;
  fxCtx.clearRect(0,0,fxW,fxH);
  if(!winFX || Date.now()>winFX.until) return;

  const dpr = window.devicePixelRatio||1;
  const c1 = COLS[0].getBoundingClientRect();
  const c3 = COLS[2].getBoundingClientRect();
  const fr = reelFrameEl.getBoundingClientRect();
  const X = x => (x - fr.left)*dpr, Y = y => (y - fr.top)*dpr;

  const ch = c1.height;
  const midY=c1.top+ch/2, cell=ch/3, topY=midY-cell, centerY=midY, bottomY=midY+cell;
  const leftX=c1.left, rightX=c3.right;

  fxCtx.save();
  fxCtx.lineWidth=6*dpr;
  fxCtx.strokeStyle="rgba(34,211,238,.70)";
  fxCtx.fillStyle="rgba(250,204,21,.16)";

  function band(y){
    const pad=6*dpr, h=cell*0.84*dpr, y0=Y(y-(h/dpr)/2), x0=X(leftX)+pad, x1=X(rightX)-pad, r=12*dpr;
    fxCtx.beginPath();
    fxCtx.moveTo(x0+r,y0);
    fxCtx.arcTo(x1,y0,x1,y0+h,r);
    fxCtx.arcTo(x1,y0+h,x0,y0+h,r);
    fxCtx.arcTo(x0,y0+h,x0,y0,r);
    fxCtx.arcTo(x0,y0,x1,y0,r);
    fxCtx.closePath(); fxCtx.fill(); fxCtx.stroke();
  }
  function diag(x0,y0,x1,y1){ fxCtx.beginPath(); fxCtx.moveTo(X(x0)+8*dpr,Y(y0)); fxCtx.lineTo(X(x1)-8*dpr,Y(y1)); fxCtx.stroke(); }

  (winFX.lines||[]).forEach(line=>{
    if(line==="Arriba") band(topY);
    if(line==="Centro") band(centerY);
    if(line==="Abajo")  band(bottomY);
    if(line==="Diag ‚Üò") diag(leftX,topY,rightX,bottomY);
    if(line==="Diag ‚Üó") diag(leftX,bottomY,rightX,topY);
  });

  fxCtx.restore();
}
function clampMod(n,m){ return ((n % m) + m) % m; }

function drawSealBET300(ctx, x, y, cell){
  const r = cell*0.38;
  ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2);
  ctx.fillStyle = "rgba(10,15,35,.92)"; ctx.fill();

  const g = ctx.createLinearGradient(x,y-r,x,y+r);
  g.addColorStop(0,"#ef4444");
  g.addColorStop(1,"#facc15");
  ctx.beginPath(); ctx.arc(x,y,r*0.82,0,Math.PI*2);
  ctx.fillStyle = g; ctx.fill();

  ctx.save();
  ctx.fillStyle = "#071016";
  ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.font = `900 ${Math.floor(cell*0.22)}px system-ui,Segoe UI,Roboto`;
  ctx.fillText("BET", x, y - r*0.22);
  ctx.font = `900 ${Math.floor(cell*0.30)}px system-ui,Segoe UI,Roboto`;
  ctx.fillText("300", x, y + r*0.18);
  ctx.restore();
}
function drawSymbol(ctx, text, x, y, cell, scale=1){
  ctx.save(); ctx.translate(x,y); ctx.scale(scale,scale); ctx.translate(-x,-y);
  if(text==="BET300"){ drawSealBET300(ctx, x, y, cell); }
  else{
    ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillStyle="#f2f5ff";
    ctx.font = `${Math.floor(cell*0.52)}px system-ui,Apple Color Emoji,Segoe UI Emoji`;
    ctx.fillText(text, x, y);
  }
  ctx.restore();
}
function drawReel(ctx, y, reelIndex){
  const w=ctx.canvas.width, h=ctx.canvas.height;
  ctx.clearRect(0,0,w,h);
  const cell = h/3;
  const yoff = (y%1)*cell;

  for(let i=0;i<3;i++){
    const top = i*cell - yoff + cell;
    const grad=ctx.createLinearGradient(0,top,0,top+cell);
    grad.addColorStop(0,"rgba(239,68,68,.14)");
    grad.addColorStop(1,"rgba(34,211,238,.10)");
    ctx.fillStyle=grad;
    const pad=8;
    ctx.fillRect(pad, top+8, w-pad*2, cell-16);
    ctx.strokeStyle="rgba(255,255,255,.06)";
    ctx.lineWidth=2;
    ctx.strokeRect(pad, top+8, w-pad*2, cell-16);
  }

  const now = Date.now();
  const pulse = (winAnim && now<winAnim.until) ? (0.5+0.5*Math.sin((now/80))) : 0;

  for(let i=-1;i<=3;i++){
    const idx = clampMod(Math.floor(y)+i, SYMBOLS.length);
    const sym = SYMBOLS[idx];
    const yy = (i*cell - yoff) + h/2;

    let row = (i===0)?0 : (i===1)?1 : (i===2)?2 : -1;
    let scale = 1;
    if(row>=0 && winAnim && winAnim.cells[reelIndex] && winAnim.cells[reelIndex].has(row)){
      scale = 1 + 0.12*pulse;
    }
    drawSymbol(ctx, sym, w/2, yy, cell, scale);
  }

  if(haloActive){
    const t = Date.now()/10;
    const cx=w/2, cy=h/2, r1=(h/3)*0.62 + (Math.sin(t/180)+1)/2*10, r2=r1+16;
    const grad = ctx.createRadialGradient(cx,cy,r1*0.2, cx,cy,r2);
    grad.addColorStop(0,"rgba(250,204,21,.20)");
    grad.addColorStop(1,"rgba(34,211,238,.05)");
    ctx.beginPath(); ctx.arc(cx,cy,r2,0,Math.PI*2);
    ctx.fillStyle=grad; ctx.fill();
  }
}

/* Luces */
function placeBulbs(){
  const wrap = document.getElementById('slotBox');
  const frame = document.getElementById('reelFrame');
  const bulbs = document.getElementById('bulbs');
  bulbs.innerHTML='';
  const w = wrap.clientWidth, h = frame.clientHeight + 20;

  function addBulb(x,y,i){
    const b=document.createElement('i');
    b.style.left=x+'px'; b.style.top=y+'px';
    b.style.background = (i%3===0)?'#facc15': (i%3===1)?'#ef4444':'#22d3ee';
    b.style.animation = `bulbOn ${900+((i%5)*120)}ms infinite`;
    bulbs.appendChild(b);
  }
  const perSide = 12;
  for(let i=0;i<=perSide;i++){ addBulb(i*(w/perSide), -4, i); }
  for(let i=0;i<=perSide;i++){ addBulb(i*(w/perSide), h+4, i+100); }
  for(let i=0;i<=perSide;i++){ addBulb(-4, i*(h/perSide), i+200); }
  for(let i=0;i<=perSide;i++){ addBulb(w+4, i*(h/perSide), i+300); }
}

/* UI */
const spinBtn = document.getElementById('spinBtn');
const claimBtn= document.getElementById('claimBtn');
const badge   = document.getElementById('badge');
const title   = document.getElementById('title');
const subtitle= document.getElementById('subtitle');
const resultLine = document.getElementById('resultLine');
const stampEl = document.getElementById('stampLine');
const hintEl = document.getElementById('hint');
const historyList = document.getElementById('historyList');

/* Modal */
const prizeModal = document.getElementById('prizeModal');
const mPrize = document.getElementById('mPrize');
const mCode  = document.getElementById('mCode');
const mTs    = document.getElementById('mTs');
const mClaim = document.getElementById('mClaim');
const mClose = document.getElementById('mClose');
const closeModalX = document.getElementById('closeModal');

function openModal(prizeLabel, code, ts){
  mPrize.textContent = prizeLabel;
  mCode.textContent  = code;
  mTs.textContent    = ts;
  const msg = whatsappText(prizeLabel);
  mClaim.onclick = ()=>location.href=`https://wa.me/${WP}?text=${encodeURIComponent(msg)}`;
  prizeModal.classList.add('show');
}
function closeModal(){ prizeModal.classList.remove('show'); }
mClose.onclick = closeModal; closeModalX.onclick = closeModal;
prizeModal.addEventListener('click',e=>{ if(e.target===prizeModal) closeModal(); });

/* Utils */
function money(n){ return "$"+n.toLocaleString("es-AR"); }
function whatsappText(prizeLabel){
  const code = localStorage.getItem('slot_code') || '(SIN-COD)';
  const ts   = localStorage.getItem('slot_ts')   || tsString();
  return `Hola, gan√© ${prizeLabel} en el Slot Navidad BET300 y quiero reclamarlo con mi pr√≥xima carga. C√≥digo: ${code} ¬∑ ${ts}`;
}
function confettiBurst(){
  const el=document.getElementById('confetti'); el.innerHTML='';
  const n=28;
  for(let i=0;i<n;i++){
    const p=document.createElement('i');
    p.style.left=(Math.random()*100)+'vw';
    p.style.animationDelay=(Math.random()*0.5)+'s';
    p.style.background = Math.random()<.5
      ? 'linear-gradient(#facc15,#ef4444)'
      : 'linear-gradient(#37f3ff,#7cfaff)';
    el.appendChild(p);
  }
  setTimeout(()=>{el.innerHTML='';},1800);
}

/* Persistencia diaria */
function restoreDaily(){
  const today=todayKey(); const stored=localStorage.getItem('slot_date');
  if(stored && stored!==today){
    localStorage.removeItem('slot_done');
    localStorage.removeItem('slot_prize');
    localStorage.removeItem('slot_code');
    localStorage.removeItem('slot_ts');
    localStorage.setItem('slot_date',today);
  }else if(!stored){ localStorage.setItem('slot_date',today); }
}
function restorePrizeIfAny(){
  const done=localStorage.getItem('slot_done')==='1';
  const saved=localStorage.getItem('slot_prize');
  if(done && saved){
    const p=JSON.parse(saved);
    const code = localStorage.getItem('slot_code') || '‚Äî';
    const ts   = localStorage.getItem('slot_ts')   || tsString();
    badge.textContent=money(p.value);
    title.textContent="üéâ ¬°Premio obtenido!";
    subtitle.innerHTML=`Recib√≠s <b>${money(p.value)} extra</b> con tu pr√≥xima carga.`;
    stampEl.textContent=`C√≥digo: ${code} ¬∑ ${ts}`;
    claimBtn.disabled=false; spinBtn.disabled=true;
    const msg=whatsappText(money(p.value));
    claimBtn.onclick=()=>location.href=`https://wa.me/${WP}?text=${encodeURIComponent(msg)}`;
  }
}
function scheduleMidnightReset(){
  const now=new Date();
  const midnight=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,0,5,0);
  setTimeout(()=>{
    localStorage.removeItem('slot_done');
    localStorage.removeItem('slot_prize');
    localStorage.removeItem('slot_code');
    localStorage.removeItem('slot_ts');
    localStorage.setItem('slot_date',todayKey());

    spinBtn.disabled=false;
    badge.textContent='-';
    title.textContent='Ten√©s 1 giro disponible';
    subtitle.innerHTML='Los premios se acreditan con tu <b>pr√≥xima carga m√≠nima</b>.';
    stampEl.textContent='';
    resultLine.textContent='‚Äî';
    hintEl.textContent='Tip: mejor visual en vertical üì±';
  }, midnight.getTime()-now.getTime());
}
function endOfDay(){
  const n=new Date();
  const end=new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,0,0).getTime();
  return end>Date.now()?end:new Date(n.getFullYear(),n.getMonth(),n.getDate()+1,23,59,0,0).getTime()
}
function tickCountdown(){
  const ms=endOfDay()-Date.now();
  const total=Math.max(0,Math.floor(ms/1000));
  const h=Math.floor(total/3600), m=Math.floor((total%3600)/60), s=total%60;
  document.getElementById('countdown').textContent =
    h>0?`${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`
       :`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

/* Probabilidades */
function pickCenters(){
  const s = ()=> SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
  const r = Math.random();
  if(r < 0.10){ return ["BET300","BET300","BET300"]; }
  else if(r < 0.30){
    let x = s(); while(x==="BET300") x=s();
    return [x,x,x];
  } else {
    let a=s(), b=s(), c=s();
    if(a===b && b===c){ c = (c==="BET300")?"üéÅ":"BET300"; }
    return [a,b,c];
  }
}
function visibleFor(colIndex){
  const y = reelY[colIndex];
  const base = Math.floor(y);
  const top    = SYMBOLS[clampMod(base - 1, SYMBOLS.length)];
  const center = SYMBOLS[clampMod(base,     SYMBOLS.length)];
  const bottom = SYMBOLS[clampMod(base + 1, SYMBOLS.length)];
  return { top, center, bottom };
}
function rowIndexForLine(lineName){
  if(lineName==="Arriba") return 0;
  if(lineName==="Centro") return 1;
  if(lineName==="Abajo")  return 2;
  return null;
}
function diagRows(lineName){
  if(lineName==="Diag ‚Üò") return [0,1,2];
  if(lineName==="Diag ‚Üó") return [2,1,0];
  return null;
}
function evaluateAllWins(grid){
  const lines = [
    {name:"Arriba", r:[grid.r1.top,    grid.r2.top,    grid.r3.top]},
    {name:"Centro", r:[grid.r1.center, grid.r2.center, grid.r3.center]},
    {name:"Abajo",  r:[grid.r1.bottom, grid.r2.bottom, grid.r3.bottom]},
    {name:"Diag ‚Üò", r:[grid.r1.top,    grid.r2.center, grid.r3.bottom]},
    {name:"Diag ‚Üó", r:[grid.r1.bottom, grid.r2.center, grid.r3.top]},
  ];

  const details=[];
  let total=0;

  for(const L of lines){
    const [a,b,c] = L.r;
    if (a!==b) continue;

    if (a===b && b===c){
      const kind = (a==="BET300") ? "jackpot" : "triple";
      const prize = (kind==="jackpot") ? 10000 : 5000;
      total += prize;
      details.push({line:L.name, kind, prize, symbols:[a,b,c]});
      continue;
    }

    if (a===b && c!==b){
      const prize=2000;
      total += prize;
      details.push({line:L.name, kind:"pair", prize, symbols:[a,b,c]});
    }
  }

  if(details.length===0){
    return { total:1000, details:[], kind:"none" };
  }

  const hasJackpot = details.some(d=>d.kind==="jackpot");
  const hasTriple  = details.some(d=>d.kind==="triple");
  const mainKind = hasJackpot ? "jackpot" : hasTriple ? "triple" : "pair";
  return { total, details, kind: mainKind };
}

/* Historial */
function pushHistory(entry){
  const arr = JSON.parse(localStorage.getItem('slot_hist')||"[]");
  arr.unshift(entry);
  while(arr.length>5) arr.pop();
  localStorage.setItem('slot_hist', JSON.stringify(arr));
}
function renderHistory(){
  const arr = JSON.parse(localStorage.getItem('slot_hist')||"[]");
  historyList.innerHTML = arr.map(e=>`<li>${e.ts} ¬∑ ${money(e.prize)} ¬∑ ${e.text}</li>`).join('') || '<li>Sin registros</li>';
}

/* Render loop */
document.addEventListener('click',()=>AudioKit.unlock(),{once:true});
function startRenderLoop(){
  function renderAll(){
    for(let i=0;i<3;i++) drawReel(CTX[i], reelY[i], i);
    if(haloActive && Date.now()>haloUntil){ haloActive=false; }
    renderWinFX();
    requestAnimationFrame(renderAll);
  }
  requestAnimationFrame(renderAll);
}

/* Botones */
const spinBtn = document.getElementById('spinBtn');
spinBtn.addEventListener('click', ()=>{
  if(spinning) return;
  if(localStorage.getItem('slot_done')==='1'){
    alert("Ya usaste tu chance de hoy üéÑ");
    return;
  }

  spinning=true;
  spinBtn.disabled=true;
  claimBtn.disabled=true;
  hintEl.textContent='‚Äî';

  let stopLoop=null;
  if(soundOn) stopLoop = AudioKit.spinLoop();

  const centers = pickCenters();
  const idx = s => SYMBOLS.indexOf(s);
  const indexes = centers.map(idx);

  const baseTurns = [11,13,15];
  const targetY = indexes.map((ix,i)=> baseTurns[i] + ix + Math.random()*0.12);

  const start = performance.now();
  const dur = [1300,1600,1900];

  (function anim(t){
    let done=0;
    for(let i=0;i<3;i++){
      const k = Math.min(1,(t-start)/dur[i]);
      const ease = 1-Math.pow(1-k,3);
      reelY[i] = ease*targetY[i];
      if(k>=1) done++;
    }
    if(done<3){ requestAnimationFrame(anim); }
    else { if(soundOn && stopLoop){ stopLoop(); } onStop(); }
  })(start);
});

async function onStop(){
  const grid = { r1: visibleFor(0), r2: visibleFor(1), r3: visibleFor(2) };
  const verdict = evaluateAllWins(grid);

  if(verdict.details.some(d=>d.kind==="jackpot")){
    haloActive = true;
    haloUntil = Date.now()+1200;
  }

  const prizeValue = verdict.total;
  const prizeLabel = money(prizeValue);
  const code = await makeClaimCode(prizeLabel);
  const ts   = tsString(new Date());

  localStorage.setItem('slot_code', code);
  localStorage.setItem('slot_ts', ts);
  localStorage.setItem('slot_prize', JSON.stringify({type:'money', value:prizeValue}));
  localStorage.setItem('slot_done','1');
  localStorage.setItem('slot_date',todayKey());

  badge.textContent = prizeLabel;

  title.textContent =
    (verdict.kind==="jackpot") ? "üèÜ ¬°JACKPOT $10.000!" :
    (verdict.kind==="triple")  ? "üéâ ¬°3 iguales!" :
    (verdict.kind==="pair")    ? "‚ú® ¬°2 iguales!" :
                                 "üéÅ Premio garantizado";

  subtitle.innerHTML =
    (verdict.kind==="jackpot") ? `üéâ ¬°Te llev√°s el premio mayor! Recib√≠s <b>${prizeLabel} extra</b> con tu pr√≥xima carga.` :
    (verdict.kind==="triple")  ? `üî• Tres iguales. Recib√≠s <b>${prizeLabel} extra</b> con tu pr√≥xima carga.` :
    (verdict.kind==="pair")    ? `‚ú® Dos iguales desde la primera columna. Recib√≠s <b>${prizeLabel} extra</b> con tu pr√≥xima carga.` :
                                 `Gracias por jugar. Recib√≠s <b>${prizeLabel} extra</b> con tu pr√≥xima carga.`;

  stampEl.textContent = `C√≥digo: ${code} ¬∑ ${ts}`;

  const msg = whatsappText(prizeLabel);
  claimBtn.disabled=false;
  claimBtn.onclick=()=>location.href=`https://wa.me/${WP}?text=${encodeURIComponent(msg)}`;

  const centersNow = [grid.r1.center, grid.r2.center, grid.r3.center];
  const linesTxt = (verdict.details.length>0)
    ? verdict.details.map(d=>`${d.kind==="jackpot"?"JACKPOT":d.kind==="triple"?"3 iguales":"2 iguales"} ¬∑ L√≠nea: ${d.line}`).join(" ‚Ä¢ ")
    : "Sin acierto";
  resultLine.textContent = `${linesTxt} ‚Ä¢ S√≠mbolos: ${centersNow.join(" | ")}`;

  const winningLines = verdict.details.map(d=>d.line);
  if(winningLines.length>0) flashWin(winningLines);

  winAnim = { cells:{0:new Set(),1:new Set(),2:new Set()}, until: Date.now()+1200 };
  verdict.details.forEach(d=>{
    const diag = diagRows(d.line);
    if(diag){
      const cols = (d.kind==="pair") ? [0,1] : [0,1,2];
      cols.forEach(ci=> winAnim.cells[ci].add(diag[ci]));
    }else{
      const row = rowIndexForLine(d.line);
      const cols = (d.kind==="pair") ? [0,1] : [0,1,2];
      cols.forEach(ci=> winAnim.cells[ci].add(row));
    }
  });

  if(soundOn) AudioKit.win(verdict.kind);
  confettiBurst();

  const histText = (verdict.details.length>0) ? verdict.details.map(d=>`${d.line} (${d.kind})`).join(", ") : "Sin acierto";
  pushHistory({ts, prize:prizeValue, text:histText});
  renderHistory();

  const delay = haloActive ? Math.max(0, haloUntil - Date.now()) : 0;
  setTimeout(()=> openModal(prizeLabel, code, ts), delay);

  spinning=false;
}

/* Init */
function init(){
  sizeFx();
  placeBulbs();
  restoreDaily();
  restorePrizeIfAny();
  tickCountdown();
  renderHistory();
  setInterval(tickCountdown,1000);
  scheduleMidnightReset();
  reelY=[0,0,0];
  startRenderLoop();
}
init();
</script>
</body>
</html>
